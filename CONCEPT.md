# Dochi - 컨셉 문서

## 정의

Dochi는 로컬 디바이스의 능력을 가진 AI 에이전트 플랫폼입니다. 각 에이전트는 고유한 페르소나를 갖고, 디바이스에서 직접 명령을 실행하며, 사용자와 자연스럽게 상호작용합니다.

## 이름

"도치"는 고슴도치에서 따왔습니다. 부르기 쉬운 이름이 필요했습니다.

## 핵심 목표

**AI 에이전트가 로컬 디바이스를 몸처럼 사용한다.**

ChatGPT나 Claude 같은 클라우드 AI는 텍스트만 주고받습니다. Dochi의 에이전트는 다릅니다. 디바이스에 상주하며 bash를 실행하고, 앱을 열고, 파일을 읽고, 시스템을 제어합니다. AI에게 손과 발을 주는 것입니다.

## 전체 구조

```
사용자 (아빠)
│
├── 개인 컨텍스트              ← 사용자가 직접 관리, 모든 워크스페이스에서 접근
│   └── "커피 좋아함, MBTI INTJ, 생일 3/15"
│
├── 가족 워크스페이스
│   ├── 워크스페이스 기억       ← "고양이 나비, 민수 초3, 집주소 ..."
│   ├── 에이전트: 도치 (비서), 키키 (아이친구)
│   ├── 멤버: 엄마, 아빠, 민수
│   └── 디바이스: 집 Mac ←──┐
│                            │  하나의 디바이스가
├── 팀 워크스페이스             │  여러 워크스페이스에
│   ├── 워크스페이스 기억       ← "프로젝트 Dochi, 스프린트 3주차 ..."
│   ├── 에이전트: 코디 (개발)
│   ├── 멤버: 아빠, 동료A, 동료B
│   └── 디바이스: 집 Mac ←──┘, 업무 Mac, 슬랙 봇
│
└── (더 많은 워크스페이스 가능)
```

사용자는 **여러 워크스페이스**를 가질 수 있습니다. 가족용, 팀용, 사이드 프로젝트용 등. 디바이스 하나가 여러 워크스페이스에 동시에 등록되어, 같은 Mac에서 가족 에이전트와 팀 에이전트가 함께 동작합니다.

## 컨텍스트 관리

컨텍스트는 4개 계층으로 나뉘며, LLM 시스템 프롬프트에 순서대로 조합됩니다:

```
┌─────────────────────────────────────────────┐
│ 1. 에이전트 system.md (페르소나, 행동 규칙)    │  ← 에이전트별
├─────────────────────────────────────────────┤
│ 2. 워크스페이스 기억 (공유 정보)               │  ← 워크스페이스 멤버 전체
├─────────────────────────────────────────────┤
│ 3. 에이전트 기억 (전문 분야 축적)              │  ← 에이전트별
├─────────────────────────────────────────────┤
│ 4. 개인 컨텍스트 (사용자 정보)                │  ← 사용자 소유, 워크스페이스 횡단
└─────────────────────────────────────────────┘
```

| 계층 | 소유자 | 범위 | 관리 | 예시 |
|------|--------|------|------|------|
| **에이전트 지침** | 에이전트 | 에이전트 고유 | `system.md` 편집 | "너는 시니어 개발자 코디야" |
| **워크스페이스 기억** | 워크스페이스 | 멤버 전체 공유 | 자동 축적 + 수동 편집 | "고양이 나비", "스프린트 3주차" |
| **에이전트 기억** | 에이전트 | 에이전트 고유 | 자동 축적 | 코디: "Dochi는 Swift+SwiftUI" |
| **개인 컨텍스트** | 사용자 | 모든 워크스페이스 | 사용자 직접 관리 | "커피 좋아함", "알러지: 새우" |

### 개인 컨텍스트

개인 컨텍스트는 **사용자에게 귀속**되며 워크스페이스를 횡단합니다:

- 가족 워크스페이스에서 "아빠는 커피 좋아해" → 개인 컨텍스트에 저장
- 팀 워크스페이스에서도 동일한 정보 접근 가능
- 사용자가 직접 확인하고 편집할 수 있는 UI 제공
- 민감한 정보는 개인 컨텍스트에만 저장 (다른 멤버에게 노출 안 됨)

### 워크스페이스 기억

워크스페이스 기억은 **해당 워크스페이스의 모든 멤버와 에이전트**가 공유합니다:

- 대화에서 자동 추출: "우리 집 고양이 이름은 나비야" → 가족 워크스페이스 기억
- 멤버 누구나 편집 가능
- 에이전트가 바뀌어도 워크스페이스 기억은 유지

### 멀티 워크스페이스와 디바이스

```
집 Mac (디바이스)
├── 가족 워크스페이스 활성
│   ├── 도치 (비서) — 웨이크워드 "도치야"
│   └── 키키 (아이친구) — 웨이크워드 "키키야"
│
└── 팀 워크스페이스 활성
    └── 코디 (개발) — 웨이크워드 "코디야"

→ "도치야" → 가족 워크스페이스 컨텍스트로 대화
→ "코디야" → 팀 워크스페이스 컨텍스트로 대화
→ 두 워크스페이스의 에이전트가 하나의 Mac에서 동시에 대기
```

디바이스는 등록된 모든 워크스페이스의 에이전트를 동시에 활성화합니다. 웨이크워드나 UI 선택으로 어떤 워크스페이스의 에이전트와 대화할지 결정됩니다.

## 에이전트 모델

### 에이전트 = 페르소나 + 능력

각 에이전트는 독립적인 `system.md`로 정의됩니다:

| 요소 | 설명 | 예시 |
|------|------|------|
| **페르소나** | 성격, 말투, 역할 | "친절한 비서", "시니어 개발자", "호기심 많은 친구" |
| **도구 권한** | 사용 가능한 도구 목록 | 코디: bash + 파일 전체 허용 / 키키: bash 제한 |
| **웨이크워드** | 음성 호출어 | "도치야", "코디야", "키키야" |
| **기억** | 워크스페이스 기억 + 에이전트 고유 기억 | 코디: 프로젝트 히스토리 / 키키: 학습 진도 |

새 에이전트를 만들려면 워크스페이스에서 `system.md`를 작성하고 이름과 웨이크워드를 지정하면 됩니다.

## 로컬 디바이스 능력

Dochi의 핵심 차별점은 **로컬 디바이스를 직접 제어**하는 것입니다.

### Shell 실행

에이전트가 bash 명령어를 직접 실행합니다:

```
사용자: "프로젝트 빌드해줘"
코디:   $ cd ~/repo/myapp && npm run build
        → 빌드 완료. 에러 없음.

사용자: "디스크 용량 확인해줘"
도치:   $ df -h /
        → 256GB 중 180GB 사용 (70%). 여유 76GB.
```

### 앱 제어

macOS 앱을 열고 조작합니다:

```
사용자: "엄마한테 FaceTime 걸어줘"
도치:   → FaceTime 열기 → 엄마 연락처로 통화 시작

사용자: "이 코드 Claude Code로 열어줘"
코디:   → claude 실행 → 현재 프로젝트 컨텍스트 전달

사용자: "발표자료 키노트로 열어줘"
도치:   → Keynote에서 파일 열기
```

### 코딩 에이전트 연동

Dochi는 Claude Code, OpenCode 같은 코딩 에이전트를 **직접 실행하고 중계**합니다. 단순히 앱을 여는 것이 아니라, 세션을 관리하고 작업을 위임하고 결과를 받아옵니다.

```
사용자: "코디야, 로그인 API에 rate limit 추가해줘"
코디:   → Claude Code 세션 시작
        → "src/api/auth.ts의 로그인 엔드포인트에 rate limit 미들웨어 추가" 전달
        → Claude Code가 코드 수정
        → 결과 요약: "로그인 엔드포인트에 분당 5회 제한 추가했어요. 테스트도 통과합니다."

사용자: "방금 세션 이어서, 회원가입에도 적용해줘"
코디:   → 기존 Claude Code 세션 재개
        → 추가 지시 전달

사용자: "지금 코딩 세션 뭐 하고 있어?"
코디:   → 활성 세션 상태 조회 → "Claude Code에서 auth 모듈 작업 중이에요."
```

#### 연동 방식

| 방식 | 설명 | 사용 시나리오 |
|------|------|-------------|
| **태스크 위임** | 코딩 에이전트에 작업 지시, 완료 후 결과 수신 | "이 함수 리팩토링해줘" |
| **세션 중계** | 사용자 ↔ 코딩 에이전트 사이에서 실시간 중계 | 복잡한 작업, 대화형 코딩 |
| **세션 관리** | 세션 시작/중단/재개, 여러 세션 병렬 관리 | "아까 작업 이어서 해줘" |
| **결과 요약** | 코딩 에이전트의 출력을 사용자에게 요약 전달 | diff 요약, 에러 설명 |

#### 지원 코딩 에이전트

| 에이전트 | CLI | 특징 |
|---------|-----|------|
| Claude Code | `claude` | Anthropic 공식, 자율 코딩 |
| OpenCode | `opencode` | 오픈소스, 멀티 LLM |
| (확장 가능) | 설정으로 추가 | CLI 기반이면 연동 가능 |

### 지원하는 로컬 능력

| 능력 | 방법 | 예시 |
|------|------|------|
| **Shell 실행** | bash/zsh | 빌드, 스크립트, 시스템 조회 |
| **코딩 에이전트** | claude, opencode CLI | 코드 작성/수정, 세션 관리, 결과 중계 |
| **앱 열기/제어** | open, AppleScript | FaceTime, Keynote, Finder |
| **파일 관리** | 파일시스템 접근 | 파일 읽기/쓰기/정리 |
| **Apple Shortcuts** | shortcuts CLI | 사용자 정의 자동화 실행 |
| **미리알림/캘린더** | EventKit | 일정 관리, 할 일 추가 |
| **알림** | UserNotifications | 시스템 알림 표시 |
| **클립보드** | NSPasteboard | 복사/붙여넣기 |
| **스크린샷** | screencapture | 화면 캡처 |
| **음성 TTS** | Supertonic ONNX | 한국어 음성 출력 |
| **음성 STT** | Apple Speech | 음성 인식 입력 |

### 권한 모델

에이전트마다 실행 가능한 명령의 범위가 다릅니다:

```
도치 (기본):  앱 열기 ✓ | 파일 읽기 ✓ | bash 제한적 ✓ | rm -rf ✗
코디 (개발):  bash 전체 ✓ | 파일 쓰기 ✓ | git ✓ | 시스템 설정 ✗
키키 (아이):  앱 열기 ✓ | 미리알림 ✓ | bash ✗ | 파일 쓰기 ✗
```

위험한 명령은 사용자 확인을 요청합니다:
```
코디: rm -rf node_modules를 실행할까요? [Y/n]
```

## 대화 계층

| 계층 | 설명 | 예시 |
|------|------|------|
| **1. DM** | 나와 에이전트의 1:1 | "도치야, 오늘 일정 알려줘" |
| **2. 멀티 디바이스** | 같은 대화를 여러 기기에서 | 집에서 시작한 대화를 업무 Mac에서 이어감 |
| **3. 멀티 워크스페이스** | 워크스페이스별 컨텍스트 분리 | 가족 대화와 팀 대화가 같은 Mac에서 독립 |
| **4. 피어 메시징** | 사람 → 디바이스 | 텔레그램 "밥 먹어!" → 집 Mac TTS |
| **5. 공유 채널** | 여러 사람 + 에이전트 | 슬랙 채널에서 코디가 코드 리뷰 |

## 설계 원칙

1. **로컬 우선** — 디바이스에서 직접 실행. 클라우드는 동기화만
2. **에이전트 확장** — system.md 하나로 새 에이전트 생성
3. **투명하게** — 오픈소스, 실행 전 명령어 표시
4. **안전하게** — 에이전트별 권한 분리, 위험 명령 사용자 확인

## 아키텍처

```
                ┌──────────────────────────────────────┐
                │         Supabase (동기화 계층)          │
                │  Auth / 워크스페이스 관리 / 메시지 큐     │
                │  컨텍스트 동기화 / 디바이스 레지스트리     │
                └──────────────────┬───────────────────┘
                                   │
          ┌────────────────────────┼────────────────────────┐
          │                        │                        │
   ┌──────┴──────┐          ┌──────┴──────┐          ┌──────┴──────┐
   │   집 Mac    │          │  업무 Mac   │          │  메신저 봇   │
   │ [가족+팀 WS] │          │  [팀 WS]   │          │  [팀 WS]   │
   │             │          │             │          │             │
   │ 도치: 음성비서│          │ 코디: 개발   │          │ TG / Slack  │
   │ 키키: 아이친구│          │  bash, git  │          │ 원격 접근    │
   │ 코디: 개발   │          │ Claude Code │          │ 피어 메시징  │
   │ FaceTime    │          │ MCP 도구    │          │             │
   │ TTS, 알람   │          │             │          │             │
   └─────────────┘          └─────────────┘          └─────────────┘
        피어                      피어                      피어
```

### 클라우드 (Supabase)

클라우드는 중앙 서버가 아니라 **동기화 계층**입니다:
- **Auth**: 사용자 인증, 워크스페이스 멤버십 관리
- **워크스페이스 관리**: 멀티 워크스페이스 생성/참여/전환
- **Context DB**: 워크스페이스 기억, 에이전트 기억, 개인 컨텍스트 동기화
- **메시지 큐**: 피어 간 메시지 라우팅
- **디바이스 레지스트리**: 디바이스 목록, 워크스페이스 매핑, capabilities

### 디바이스 (피어)

각 피어는 독립적으로 동작하며 로컬 능력을 제공합니다:
- LLM 호출, 도구/명령 실행은 각 피어가 직접 수행
- 한 피어가 꺼져도 나머지에 영향 없음
- **여러 워크스페이스에 동시 등록** — 같은 Mac에서 가족/팀 에이전트가 함께 동작
- 워크스페이스별 에이전트가 한 디바이스에서 동시에 활성화

## 인터페이스

| 인터페이스 | 입력 | 출력 | 로컬 능력 | 상태 |
|-----------|------|------|----------|------|
| macOS 앱 | 텍스트, 음성 | TTS, 텍스트, 이미지 | bash, 앱 제어, 파일, Shortcuts | 구현 중 |
| CLI | 텍스트 | 텍스트 | bash, 파이프라인, 스크립팅 | 계획 |
| 텔레그램 봇 | 텍스트, 음성메시지 | 텍스트, 이미지 | 원격 디바이스 명령 | 계획 |
| 슬랙 봇 | 텍스트 | 텍스트 | 팀 채널, 원격 명령 | 계획 |

## 사용 시나리오

### 가정 (가족 워크스페이스)

- 집 Mac에 도치(비서)와 키키(아이친구) 에이전트가 상주
- "키키야, 공룡 이야기 해줘" → 키키가 아이 눈높이로 대화
- "도치야, 엄마한테 FaceTime 걸어줘" → FaceTime 앱 실행
- 부모는 텔레그램으로 "밥 먹어!" → 집 Mac에서 도치가 TTS로 전달
- "도치야, 내일 일정 알려줘" → 캘린더 조회 후 음성으로 안내

### 개발 (팀 워크스페이스)

- **같은 집 Mac**에서 "코디야" 호출 → 팀 워크스페이스 컨텍스트로 전환
- "코디야, 이 프로젝트 빌드해줘" → `npm run build` 실행
- "코디야, 로그인 API에 rate limit 추가해줘" → Claude Code 세션 시작 → 코드 수정 → 결과 요약
- "코디야, 아까 작업 이어서 해줘" → 기존 코딩 세션 재개
- 팀 워크스페이스 기억에 프로젝트 정보가 축적됨
- 업무 Mac에서도 같은 팀 컨텍스트로 이어서 작업

### 워크스페이스 간 전환

```
[집 Mac에서]
"도치야, 민수 숙제 도와줘"    → 가족 WS · 도치 · 가족 기억 사용
"코디야, PR 리뷰해줘"         → 팀 WS · 코디 · 팀 기억 사용
"도치야, 내 알러지 뭐였지?"    → 개인 컨텍스트 · 어느 WS에서든 동일

→ 웨이크워드가 워크스페이스까지 결정
→ 개인 컨텍스트는 어디서든 접근
```
