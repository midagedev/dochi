# 리라이트 계획서 (Rewrite Plan)

## Meta
- DRI: @hckim
- 상태: Phase 0~5 완료, UI/기능 확장 진행 중
- 생성: 2026-02-08
- 갱신: 2026-02-13

---

## 목표 (Outcomes)
- 스펙 우선: 구현 전에 스펙을 단일 진실원천으로 유지
- 단순하고 안전한 핵심 경험: 텍스트/음성/원격(텔레그램) 3대 플로우를 빠르고 안정적으로
- 로컬 우선과 최소 권한: 위험 동작은 기본 비활성, 명시적 확인 필요

## 비목표 (Non-Goals)
- 범용 스마트홈 전범위 통합
- 자율행동/무인 자동화
- 복잡한 멀티 플랫폼 동시 출시

---

## 범위 & 우선순위

| 구분 | 항목 |
|------|------|
| **Must** | 텍스트 대화, 음성 대화(웨이크워드+STT+TTS), 핵심 도구(미리알림/알람/검색/이미지), 컨텍스트(개인/WS/에이전트), 텔레그램 DM |
| **Should** | 모델 선택 기본정책, 컨텍스트 자동 압축, 권한 가드레일/확인 UX |
| **Could** | 모델 라우팅/폴백, 로컬 LLM, 다중 메신저, 코딩 에이전트 심화 |

---

## Phases — 완료 현황

### Phase 0 — 스펙 정착 & 스캐폴딩 ✅
- 스펙 동결 (핵심 섹션)
- 새 폴더/모듈 구조 생성
- 빈 화면/설정/대화 스텁
- `CLAUDE.md` 새 구조에 맞게 갱신

### Phase 1 — 텍스트 플로우 MVP ✅
- 컨텍스트 조합
- LLM SSE 스트리밍 + 프로바이더 어댑터 (OpenAI, Anthropic, Z.AI)
- 도구 호출 (Safe 카테고리)
- 대화 저장
- 취소/에러 처리
- 상태 머신 구현
- 레거시 파일 마이그레이션

### Phase 2 — 음성 플로우 ✅
- 웨이크워드 매칭 + 에이전트 라우팅 (JamoMatcher)
- Apple STT (SpeechService)
- Supertonic TTS 서비스 + 문장 단위 스트리밍 (SentenceChunker)
- 연속 대화 + barge-in
- UX 사운드 (SoundService)

### Phase 3 — 도구 & 권한 ✅
- 전체 내장 도구 구현 (13개)
- MCP 서버 연동 (MCPService)
- 권한 시스템 (safe/sensitive/restricted)
- 사용자 확인 UX (ToolConfirmationBannerView)

### Phase 4 — 원격 인터페이스 & 동기화 ✅
- 텔레그램 DM + 폴링
- Supabase 인증/워크스페이스/리더락
- 동기화 기본 구조 (마커 기반)

### Phase 5 — 모델 정책 & 최적화 ✅
- 모델 라우터 (ModelRouter)
- 메트릭 수집 (MetricsCollector, ExchangeMetrics)

### UI/기능 확장 (Phase A~E) ✅
Phase 0~5 이후 추가 구현:

- **Phase A**: 사이드바 리팩토링 — 워크스페이스/에이전트 피커, 관리 시트, 전환 로직
- **Phase B**: 설정 6탭 확장 — 도구 API 키(Tavily, Fal.ai), 음성 설정, 통합/계정 탭 구조
- **Phase C**: 텔레그램 메시지 처리 + MCP 서버 관리 UI + LLM 도구 노출
- **Phase D**: Supabase 로그인/회원가입 UI, 사이드바 인증 상태, 기본 동기화
- **Phase E**: TTS ONNX 추론 파이프라인 (KoreanG2P, ONNXModelManager), 상시 웨이크워드 감지
- **공통 UI**: 컨텍스트 크기 인디케이터, 빈 대화 상태 안내, 컨텍스트 인스펙터

---

## Quality Targets (정본)

모든 수치 목표의 단일 출처. 다른 문서에서는 여기를 링크.

### Latency
| 지표 | p50 | p95 |
|------|-----|-----|
| 텍스트 첫 부분 응답 | ≤ 1.0s | ≤ 2.5s |
| 텍스트 전체 응답 | ≤ 3.5s | ≤ 7s |
| TTS 첫 오디오 (사전 로드) | ≤ 800ms | - |

### Context
| 항목 | 값 |
|------|-----|
| 최대 크기 | 80k chars |
| 최근 대화 | 30개 메시지 |
| 압축 후 최소 대화 | 5개 메시지 |

### Reliability
| 항목 | 값 |
|------|-----|
| LLM 재시도 | 최대 2회, 250/750ms backoff |
| 첫 바이트 타임아웃 | 20s |
| 전체 교환 소프트 한도 | 60s |
| Tool loop 최대 | 10회 |

### Wake Word
| 지표 | 목표 |
|------|------|
| FAR | < 5% |
| FRR | < 10% |

---

## 마일스톤 & 종료 기준

| 마일스톤 | 종료 기준 | 상태 |
|---------|----------|------|
| M1 텍스트 MVP | flows.md 텍스트 수용 기준 100%. 레이턴시 목표 달성 | ✅ |
| M2 음성 MVP | 웨이크워드 FAR/FRR 밴드 충족. TTS 첫 오디오 목표 달성 | ✅ (placeholder 모드) |
| M3 도구/권한 | Safe 100% 구현. Sensitive 확인 루프 적용. 원격 기본 제한 | ✅ |
| M4 원격/동기화 | 텔레그램 플로우 수용 기준 충족. 충돌/장애 시 우아한 저하 | ✅ (기본 구조) |

---

## 브랜치 & 변경 관리
- `main`: 보호 브랜치, 리뷰 필수
- `rewrite/phase-0`: 현재 작업 브랜치 (Phase 0~5 + UI 확장)
- PR 템플릿: 관련 스펙 링크, 수용 기준 체크, 리스크/백아웃

---

## 리스크 & 대응

| 리스크 | 대응 |
|--------|------|
| 음성 품질/지연 변동 | 로컬 캐시/사전 로드, 텍스트 폴백 |
| 원격 권한 오남용 | 카테고리 제한 + 확인 루프, 로컬 재확인 |
| 동기화 장애 | fail-open, 로컬 우선, 사용자 공지 |
| 상태 관리 복잡도 | states.md 준수, 금지 조합 타입 시스템 강제 |

---

## 백아웃 계획
- 기능 플래그로 단계적 롤아웃
- 데이터 변경은 선행 마이그레이션/롤백 경로 확보
