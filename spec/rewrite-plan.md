# 리라이트 계획서 (Rewrite Plan)

## Meta
- DRI: @hckim
- 상태: Draft
- 생성: 2026-02-12
- 갱신: 2026-02-12

---

## 목표 (Outcomes)
- 스펙 우선: 구현 전에 스펙을 단일 진실원천으로 유지
- 단순하고 안전한 핵심 경험: 텍스트/음성/원격(텔레그램) 3대 플로우를 빠르고 안정적으로
- 로컬 우선과 최소 권한: 위험 동작은 기본 비활성, 명시적 확인 필요

## 비목표 (Non-Goals)
- 범용 스마트홈 전범위 통합
- 자율행동/무인 자동화
- 복잡한 멀티 플랫폼 동시 출시

---

## 범위 & 우선순위

| 구분 | 항목 |
|------|------|
| **Must** | 텍스트 대화, 음성 대화(웨이크워드+STT+TTS), 핵심 도구(미리알림/알람/검색/이미지), 컨텍스트(개인/WS/에이전트), 텔레그램 DM |
| **Should** | 모델 선택 기본정책, 컨텍스트 자동 압축, 권한 가드레일/확인 UX |
| **Could** | 모델 라우팅/폴백, 로컬 LLM, 다중 메신저, 코딩 에이전트 심화 |

---

## Phases

### Phase 0 — 스펙 정착 & 스캐폴딩
- 스펙 동결 (핵심 섹션)
- 새 폴더/모듈 구조 생성
- 빈 화면/설정/대화 스텁
- `CLAUDE.md` 새 구조에 맞게 갱신

### Phase 1 — 텍스트 플로우 MVP
- 컨텍스트 조합 ([flows.md](./flows.md#7-context-composition-flow))
- LLM SSE 스트리밍 + 프로바이더 어댑터 ([llm-requirements.md](./llm-requirements.md#provider-adapter))
- 도구 호출 (Safe 카테고리)
- 대화 저장
- 취소/에러 처리 ([flows.md](./flows.md#1-text-interaction-flow) 실패 케이스)
- 상태 머신 구현 ([states.md](./states.md))
- 레거시 파일 마이그레이션

### Phase 2 — 음성 플로우
- 웨이크워드 매칭 + 에이전트 라우팅 ([voice-and-audio.md](./voice-and-audio.md))
- Apple STT
- Supertonic ONNX TTS + 문장 단위 스트리밍
- 연속 대화 + barge-in ([states.md](./states.md#barge-in-처리))
- UX 사운드

### Phase 3 — 도구 & 권한
- 전체 내장 도구 구현 ([tools.md](./tools.md))
- MCP 서버 연동
- 권한 시스템 ([security.md](./security.md#권한-분류))
- 사용자 확인 UX

### Phase 4 — 원격 인터페이스 & 동기화
- 텔레그램 DM + progress snippet
- 보수적 원격 권한
- Supabase 동기화 ([supabase.md](./supabase.md))
- Leader lock + 디바이스 관리

### Phase 5 — 모델 정책 & 최적화
- 기본 모델 라우팅
- 재시도/타임아웃 튜닝
- 관측 지표 수집 (로컬)

---

## Quality Targets (정본)

모든 수치 목표의 단일 출처. 다른 문서에서는 여기를 링크.

### Latency
| 지표 | p50 | p95 |
|------|-----|-----|
| 텍스트 첫 부분 응답 | ≤ 1.0s | ≤ 2.5s |
| 텍스트 전체 응답 | ≤ 3.5s | ≤ 7s |
| TTS 첫 오디오 (사전 로드) | ≤ 800ms | - |

### Context
| 항목 | 값 |
|------|-----|
| 최대 크기 | 80k chars |
| 최근 대화 | 30개 메시지 |
| 압축 후 최소 대화 | 5개 메시지 |

### Reliability
| 항목 | 값 |
|------|-----|
| LLM 재시도 | 최대 2회, 250/750ms backoff |
| 첫 바이트 타임아웃 | 20s |
| 전체 교환 소프트 한도 | 60s |
| Tool loop 최대 | 10회 |

### Wake Word
| 지표 | 목표 |
|------|------|
| FAR | < 5% |
| FRR | < 10% |

---

## 마일스톤 & 종료 기준

| 마일스톤 | 종료 기준 |
|---------|----------|
| M1 텍스트 MVP | flows.md 텍스트 수용 기준 100%. 레이턴시 목표 달성 |
| M2 음성 MVP | 웨이크워드 FAR/FRR 밴드 충족. TTS 첫 오디오 목표 달성 |
| M3 도구/권한 | Safe 100% 구현. Sensitive 확인 루프 적용. 원격 기본 제한 |
| M4 원격/동기화 | 텔레그램 플로우 수용 기준 충족. 충돌/장애 시 우아한 저하 |

---

## 브랜치 & 변경 관리
- `main`: 보호 브랜치, 리뷰 필수
- `rewrite/*`: 단계별 작업 브랜치 (M1/M2/...)
- PR 템플릿: 관련 스펙 링크, 수용 기준 체크, 리스크/백아웃

---

## 리스크 & 대응

| 리스크 | 대응 |
|--------|------|
| 음성 품질/지연 변동 | 로컬 캐시/사전 로드, 텍스트 폴백 |
| 원격 권한 오남용 | 카테고리 제한 + 확인 루프, 로컬 재확인 |
| 동기화 장애 | fail-open, 로컬 우선, 사용자 공지 |
| 상태 관리 복잡도 | states.md 준수, 금지 조합 타입 시스템 강제 |

---

## 백아웃 계획
- 기능 플래그로 단계적 롤아웃
- 데이터 변경은 선행 마이그레이션/롤백 경로 확보
